{% load static %}
<!DOCTYPE html>  
<html lang="en">  
<head>  
  <meta charset="utf-8" />  
  <meta name="viewport" content="width=device-width,initial-scale=1" />  
  <link rel="icon" type="image/x-icon" href="{% static 'icons/favicon.ico' %}">
  <title>HeartNote AI ‚Äî H1 (Creative Writer)</title>  
  
  <!-- Quicksand (Google Fonts) -->  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">  
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;600&display=swap" rel="stylesheet">  
  <link rel="manifest" href="{% static 'pwa/manifest.json' %}">
<meta name="theme-color" content="#ff4d6d">
  <style>  
  :root{  
      --bg: #fff;  
      --text:#000;
      --accent:  #ff4d6d;  
      --muted: #e63950;  
--card: rgba(255,255,255,0.04);  
--glass: rgba(255,255,255,0.03);  
    } 

body.dark {
  --bg: #0e0e0f;
  --text: #f9f9fb;
  --accent: #ff5c8d;
  --muted: #ff7da3;
  --option:#000;
  --card: rgba(255, 255, 255, 0.04);
  --glass: rgba(255, 255, 255, 0.05);
}
    *{box-sizing:border-box}  
    html,body{height:100%}  
    body{  
      margin:0;  
      font-family: 'Inter', sans-serif;  
      background:var(--bg);  
      color: var(--text);  
      -webkit-font-smoothing:antialiased;  
      -moz-osx-font-smoothing:grayscale;  
      display:flex;  
      align-items:flex-start;  
      justify-content:center;  
      padding:28px;  
      gap:20px;  
    }  
    body { scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }  
  
    /* Layout container */  
    .app {  
      width:100%;  
      max-width:100%;  
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));  
      border-radius:14px;  
      padding-left: 0px;  
      padding-top: 5px;  
      padding-right: 0px;  
      overflow:hidden;  
    }  
    .app { opacity:0; animation: fadeInApp 0.8s ease forwards; }  
@keyframes fadeInApp { to { opacity:1; } }  
  
    /* Header */  
    .header {  
      display:flex;  
      align-items:center;  
      justify-content:space-between;  
      gap:12px;  
    }  
    .brand {  
      display:flex;  
      align-items:center;  
      gap:12px;  
      font-weight:700;  
      font-size:1.25rem;  
    }  
    .brand .heart {  
      background: rgba(255,255,255,0.06);  
      padding:8px;  
      border-radius:10px;  
      font-size:1.05rem;  
    }  
    .header .actions {  
      display:flex;  
      gap:10px;  
    }  
    .btn {  
      background:var(--accent);  
      border:none;  
      color:#fff;  
      padding:8px 12px;  
      border-radius:10px;  
      cursor:pointer;  
      font-weight:600;  
      font-size:0.95rem;  
      transition:transform .12s ease, box-shadow .12s ease;  
    }  
    .btn:hover{ background: #F06292; transform: scale(1.05);box-shadow:0 8px 18px rgba(186,23,74,0.18) }  
  
    /* Main grid */  
    .grid {  
      display:grid;  
      grid-template-columns: 1fr 420px;  
      gap:18px;  
      margin-top:18px;  
    }  
  
    /* Left column: controls + output */  
    .panel {  
      background:var(--card);  
     backdrop-filter: blur(10px);  
     border: 1px solid rgba(255, 77, 109, 0.2);  
      padding:16px;  
      border-radius:12px;  
      backface-visibility:hidden;  
    }  
  
    label { display:block; margin-bottom:6px; color:var(--accent); font-weight:600; font-size:0.9rem; }  
  
    .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }  
    select, textarea, input[type="range"] {  
      width:100%;  
      border-radius:10px;  
      backdrop-filter: blur(10px);  
      border: 1px solid rgba(255, 77, 109, 0.2);  
      background:transparent;  
      color: var(--text);  
      padding:10px;  
      font-size:0.95rem;  
      outline:none;  
    } 
    option{
      color:var(--option);
    }
    textarea{ min-height:90px; resize:vertical; }  
  
    .small { width:auto; display:inline-flex; gap:8px; align-items:center; }  
  
    .row { display:flex; gap:10px; margin-top:10px; align-items:center; }  
    .row .btn { padding:10px 14px; margin-bottom:20px;}  
  
    /* Handwriting animation */  
@keyframes handwriting {  
  from { stroke-dashoffset: 100%; opacity: 0.6; }  
  to { stroke-dashoffset: 0; opacity: 1; }  
}  
  
.handwriting {  
  font-family: "Caveat", cursive; /* or 'Indie Flower' */  
  font-size: 1.15rem;  
  animation: handwriting 3s ease forwards;  
  white-space: pre-wrap;  
  line-height: 1.8;  
}  
.output pre,  
.output p,  
.output h2 {  
  font-family: "Caveat", cursive !important;  
  font-size: 1.15rem;  
  line-height: 1.8;  
  white-space: pre-wrap;  
}  
  
.output pre,  
.output p {  
  color: var(--text);  
  text-shadow: 0 0 0.6px var(--text);  
}  
  
    /* output */  
    .output {  
      margin-top:14px;  
      background: var(--glass);  
      border: 1px solid rgba(255, 77, 109, 0.2);  
      padding:14px;  
      border-radius:10px;  
      min-height:140px;  
      text-align:left;  
      color:var(--text);  
      line-height:1.5;  
      font-size:1rem;  
      white-space:pre-wrap;  
    }  
  
    .output h2 { margin:0 0 8px 0; font-size:1.05rem; color:var(--text); }  
    .output .meta { font-size:0.85rem; color: var(--text); margin-bottom:8px; }  
  
    .toolbar { display:flex; gap:8px; margin-top:10px; }  
  
    .ghost { background:transparent; border:1px solid #ff4d6d; padding:8px 10px; border-radius:8px; color:#ff4d6d; cursor:pointer; }  
  
    /* History (right column) */  
    .history {  
      background:var(--card);  
      backdrop-filter: blur(10px);  
      border: 1px solid rgba(255, 77, 109, 0.2);  
      padding:12px;  
      border-radius:12px;  
      max-height:560px;  
      overflow:auto;  
    } 
    .suggest{
    background: var(--accent);
    border: none;
    color: #fff;
    padding: 8px 12px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    transition: transform .12s 
    ease, box-shadow .12s 
    ease;
    }
    .history h3{ margin:0 0 8px 0; color:var(--text) }  
    .hist-item {  
      padding:8px;  
      border-radius:8px;  
      background:transparent;  
      display:flex;  
      justify-content:space-between;  
      gap:8px;  
      margin-bottom:8px;  
      border:1px solid rgba(255,255,255,0.03);  
      cursor:pointer;  
    }  
    .hist-item:hover { background: rgba(255,255,255,0.02) }  
  
    .muted { color:var(--text); opacity:0.9; font-size:0.9rem; }  
  
    /* footer small */  
    .footnote {  
      margin-top:12px;  
      font-size:0.82rem;  
      color:var(--text);  
      opacity:0.9;  
    }
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: flex;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(4px);
  z-index: 9999;
}

.dob-box {
  background: var(--card);
  padding: 20px;
  border-radius: 16px;
  text-align: center;
  width: 280px;
}
  
    /* responsive */  
    @media (max-width:880px){  
      .grid{ grid-template-columns: 1fr; }  
      .history{ order:2; }  
    }  
    @media (max-width:768px){  
       body{  
        padding-left: 10px;  
        padding-right: 10px;  
        padding-top: 18px;  
      }  
    }  
  
  </style>  
</head>  
<body>  
  <div class="app" role="application" aria-label="HeartNote AI">    
  <div class="header">    
    <div class="brand" aria-hidden="true">    
      <div class="heart">üíû</div>    
      <div>    
        <div style="font-size:1.05rem">HeartNote AI</div>      
        <div style="font-size:0.78rem; color:var(--accent); margin-top:4px">
          Personal Writer
        </div>
      </div>    
    </div>    

    <div class="actions">   
      <button class="btn" onclick="goHome()">‚Üê</button>
      <button class="btn" id="themeToggle" title="Toggle Dark/Light">üåô</button>  
    </div>    
  </div>    

  <div class="grid">    

    <!-- Left panel -->    
    <div class="panel" aria-live="polite">    

      <label for="mode">Mode</label>    
      <div class="controls">    
        <select id="mode" aria-label="Choose mode">
          <option value="reflection">Reflection</option>  
          <option value="journal">Journal</option>  
          <option value="note">Note</option>  
          <option value="affirmation">Affirmation</option>  
          <option value="poem">Poem</option>  
          <option value="story">Story</option>  
          <option value="letter">Letter</option>  
          <option value="quote">Quote</option>  
        </select>  
      </div>    

      <label for="prompt" style="margin-top:12px">Prompt (topic / few words)</label>    
      <textarea id="prompt" placeholder="e.g. moonlight love, apology to a friend, product launch"></textarea>  
      <button id="suggestBtn" class="suggest">Suggest ‚ú®</button>  

      <div class="row" style="margin-top:12px; align-items:center;">    
        <div style="flex:1">    
          <label for="emotion">Emotion depth</label>    
          <input id="emotion" type="range" min="0" max="100" value="50" />    
          <div class="muted" id="emotionLabel">Balanced</div>    
        </div>    

        <div style="width:130px">    
          <label>&nbsp;</label>    
          <button class="btn" id="generateBtn" style="width:100%">Generate</button>    
        </div>    
      </div>    

      <div class="output" id="output" tabindex="0" aria-label="Generated output" style="font-size:1.15rem;">    
        <div class="meta muted">Your generated content will appear here.</div>    
      </div>    

      <div class="toolbar" style="margin-top:8px">     
        <button class="ghost" id="addHistoryBtn">‚≠ê Add to History</button>    
        <button class="ghost" id="clearBtn">üßπ Clear</button>    
        <div style="flex:1"></div>    
        <div class="muted" id="lenInfo">0 chars</div>    
      </div>    

      <div class="footnote">
        Tip: Try "poem about rain" or "letter: say sorry to sibling". Emotion slider controls intensity.
      </div>    
    </div>    

    <!-- Right panel: history -->    
    <aside class="history" aria-label="Recent history">    
      <h3>Recent</h3>    
      <div id="historyList"></div>    

      <div style="margin-top:10px; display:flex; gap:8px">    
        <button class="ghost" id="clearHistory">Clear</button>    
        <div style="flex:1"></div>    
        <div class="muted">Local only ‚Ä¢ private</div>    
      </div>    
    </aside>    

  </div>
</div>
<div id="dobOverlay" class="overlay" style="display: none;">
  <div class="dob-box">
    <h3>Enter your Date of Birth</h3>
    <input type="date" id="dobInput" />
    <button id="dobSubmit">Continue</button>
  </div>
</div>
  
  <script>  
    // Simple HeartNote AI h1 ‚Äî client-side  
    (function () {  
      const modeEl = document.getElementById("mode");  
      const promptEl = document.getElementById("prompt");  
      const emotionEl = document.getElementById("emotion");  
      const emotionLabel = document.getElementById("emotionLabel");  
      const generateBtn = document.getElementById("generateBtn");  
      const outputEl = document.getElementById("output");  
      const addHistoryBtn = document.getElementById("addHistoryBtn");  
      const historyList = document.getElementById("historyList");  
      const clearHistoryBtn = document.getElementById("clearHistory");  
      const lenInfo = document.getElementById("lenInfo");  
 
  
      // local storage key  
      const STORAGE_KEY = "heartnote_h1_history";  
let userDOB = localStorage.getItem("heartnote_dob") || null;
let isAdult = false;



function calculateAge(dob) {
  const birth = new Date(dob);
  const diff = Date.now() - birth.getTime();
  return Math.floor(diff / (365.25 * 24 * 60 * 60 * 1000));
}

function showDOBOverlay() {
  document.getElementById("dobOverlay").style.display = "flex";

  document.getElementById("dobSubmit").onclick = () => {
    const enteredDOB = document.getElementById("dobInput").value;
    if (!enteredDOB) return;

    localStorage.setItem("heartnote_dob", enteredDOB);
    userDOB = enteredDOB;
    validateAge();
    document.getElementById("dobOverlay").style.display = "none";
  };
}

function validateAge() {
  const age = calculateAge(userDOB);
  isAdult = age >= 18;

  const childModes = ["reflection", "journal", "note", "affirmation"];

  for (let option of modeEl.options) {
    if (!isAdult && !childModes.includes(option.value)) {
      option.disabled = true;
    } else {
      option.disabled = false;
    }
  }
}

if (!userDOB) {
  showDOBOverlay();
} else {
  validateAge();
}
  
      // helpers  
      function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }  
      function nowTs(){ return new Date().toISOString(); }  
  
      // emotion label update  
      function updateEmotionLabel() {  
        const v = parseInt(emotionEl.value,10);  
        if (v < 25) emotionLabel.textContent = "Soft";  
        else if (v < 60) emotionLabel.textContent = "Balanced";  
        else emotionLabel.textContent = "Deep";  
      }  
      emotionEl.addEventListener("input", updateEmotionLabel);  
      updateEmotionLabel();  
  
      // typing effect for output (keeps HTML safe)  
     // Writing effect ‚Äî smoother, ink-like feel ‚úçÔ∏è  
function emotionalHandwriteHTML(html, elementId, toneLevel = "medium") {
    const el = document.getElementById(elementId);
    el.innerHTML = "";
    el.classList.add("handwriting");

    let speed;
    switch (toneLevel.toLowerCase()) {
        case "deep": speed = 80; break;
        case "light": speed = 35; break;
        default: speed = 55;
    }

    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");
    const nodes = [...doc.body.childNodes];

    let nodeIndex = 0;
    let charIndex = 0;
    let currentNode;
    let currentClone;

    const fullTextLength = doc.body.innerText.length; // total chars

    function typeNext() {
        if (!currentNode || charIndex >= currentNode.textContent.length) {
            if (nodeIndex >= nodes.length) {
                // ‚ú® Done ‚Üí show char count
                const lenInfo = document.getElementById("lenInfo");
                if (lenInfo) {
                    lenInfo.textContent = `${fullTextLength} chars`;
                }
                return;
            }
            currentNode = nodes[nodeIndex++];
            currentClone = currentNode.cloneNode(false);
            el.appendChild(currentClone);
            charIndex = 0;
        }

        const text = currentNode.textContent;
        currentClone.textContent = text.slice(0, charIndex + 1);
        charIndex++;

        setTimeout(typeNext, (charIndex % 6 === 0) ? speed * 1.6 : speed);
    }

    typeNext();
}

function getToneFromEmotion(value) {
  const num = Number(value);

  if (num <= 33) return "soft";
  if (num <= 66) return "balanced";
  return "deep";
}

generateBtn.addEventListener("click", async () => {
  const mode = modeEl.value;
  const text = promptEl.value.trim();
  const emotion = emotionEl.value;
  const outputBox = document.getElementById("output");

  if (!text) {
    alert("Please enter something...");
    return;
  }

  // Convert emotion slider ‚Üí tone keyword
  const tone = getToneFromEmotion(emotion);

  outputBox.innerHTML = "‚è≥ Generating...";

  try {
    // Correct final URL
    const url = `/api/generate/?mode=${encodeURIComponent(mode)}&text=${encodeURIComponent(text)}&tone=${encodeURIComponent(tone)}`;

    const response = await fetch(url);
    const data = await response.json();

    // Handwriting animation
    emotionalHandwriteHTML(data.response, "output", tone);


  } catch (error) {
    outputBox.innerHTML = "‚ö†Ô∏è Error contacting backend.";
  }
  
});

document.addEventListener('DOMContentLoaded', function() {
    // 1. Get references to key elements
    const clearButton = document.getElementById('clearBtn');
    const outputContainer = document.getElementById('output'); // ‚ö†Ô∏è Confirm this ID!
    const descInput = document.getElementById('prompt'); // Assuming your main input field ID is 'descInput'
    const lenInfo = document.getElementById('lenInfo');
    
    // --- Helper function to update the character count ---
    function updateCharCount() {
        if (descInput && lenInfo) {
            // Get the current length of the text in the input field
            const count = descInput.value.length;
            lenInfo.textContent = `${count} chars`;
        }
    }

    // --- 1. Attach event listener for real-time typing ---
    if (descInput) {
        // Update count whenever the user types, pastes, or cuts text
        descInput.addEventListener('input', updateCharCount);
        
        // Initial call to set the correct count when the page loads
        updateCharCount();
    }
    
    // --- 2. Clear Button Logic ---
    if (clearButton) {
        clearButton.addEventListener('click', function() {
            // 2a. Clear the output content
            if (outputContainer) {
                outputContainer.innerHTML = '';
            }
            
            // 2b. Clear the input field content
            if (descInput) {
                descInput.value = '';
            }
            
            // 2c. Update the character count display to 0
            if (lenInfo) {
                lenInfo.textContent = '0 chars';
            }
            
            // Put focus back on the input field for immediate typing
            if (descInput) {
                descInput.focus();
            }
        });
    }

    // Optional: Log an error if elements aren't found for debugging
    if (!clearButton || !outputContainer || !descInput || !lenInfo) {
        console.error("Missing one or more required elements (clearBtn, outputContainer, descInput, or lenInfo).");
    }
});

       // History management  
      function loadHistory() {  
        const raw = localStorage.getItem(STORAGE_KEY);  
        let arr = [];  
        try { arr = raw ? JSON.parse(raw) : []; } catch(e){ arr = []; }  
        historyList.innerHTML = "";  
        if (!arr.length) {  
          historyList.innerHTML = `<div class="muted">No saved entries yet. Generate and "Add to History".</div>`;  
          return;  
        }  
        arr.forEach((it, idx) => {  
          const div = document.createElement("div");  
          div.className = "hist-item";  
          div.innerHTML = `<div style="flex:1"><strong style="display:block">${it.mode.toUpperCase()}</strong><div style="font-size:0.9rem;color:var(--text);margin-top:6px">${it.preview}</div></div>  
                           <div style="min-width:72px;display:flex;flex-direction:column;gap:6px">  
                             <button class="ghost" data-idx="${idx}" data-action="open">Open</button>  
                             <button class="ghost" data-idx="${idx}" data-action="delete">Delete</button>  
                           </div>`;  
          historyList.appendChild(div);  
        });  
      }  
  
      // Add to history (stores HTML + meta)  
      addHistoryBtn.addEventListener("click", () => {  
        const text = outputEl.innerText.trim();  
        if (!text) { alert("Nothing to add."); return; }  
        const mode = modeEl.value;  
        const preview = text.length > 90 ? text.slice(0,90) + "‚Ä¶" : text;  
        const raw = localStorage.getItem(STORAGE_KEY);  
        let arr = raw ? JSON.parse(raw) : [];  
        arr.unshift({ ts: nowTs(), mode, preview, text });  
        // keep 60 entries max  
        if (arr.length > 60) arr = arr.slice(0,60);  
        localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));  
        loadHistory();  
        addHistoryBtn.textContent = "Saved ‚úì";  
        setTimeout(()=> addHistoryBtn.textContent = "‚≠ê Add to History",1200);  
      });  
  
      // History click handling (delegation)  
      historyList.addEventListener("click", (ev) => {  
        const btn = ev.target.closest("button[data-action]");  
        if (!btn) return;  
        const idx = parseInt(btn.dataset.idx,10);  
        const action = btn.dataset.action;  
        const raw = localStorage.getItem(STORAGE_KEY);  
        const arr = raw ? JSON.parse(raw) : [];  
        if (action === "open") {  
          const it = arr[idx];  
          if (!it) return;  
          // open in output area  
          outputEl.innerText = it.text;  
          lenInfo.textContent = `${it.text.length} chars`;  
          // set mode to the saved mode  
          if (it.mode) modeEl.value = it.mode;  
        } else if (action === "delete") {  
          if (!confirm("Delete this saved entry?")) return;  
          arr.splice(idx,1);  
          localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));  
          loadHistory();  
        }  
      });  
  
      clearHistoryBtn.addEventListener("click", () => {  
        if (!confirm("Clear all saved history?")) return;  
        localStorage.removeItem(STORAGE_KEY);  
        loadHistory();  
      });  
  
      // initialize  
      loadHistory();  
  
      // small accessibility: allow Enter on prompt to generate when focused + ctrl  
      promptEl.addEventListener("keydown", (e) => {  
        if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {  
          e.preventDefault();  
          generateBtn.click();  
        }  
      });  
  
    })();
    // Theme toggle
const themeToggle = document.getElementById("themeToggle");
const userTheme = localStorage.getItem("valantine_theme");
if (userTheme === "dark") document.body.classList.add("dark");

function updateThemeIcon() {
  themeToggle.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
}
updateThemeIcon();

themeToggle.addEventListener("click", () => {
  document.body.classList.toggle("dark");
  const isDark = document.body.classList.contains("dark");
  localStorage.setItem("valantine_theme", isDark ? "dark" : "light");
  updateThemeIcon();
});
// All suggestion sets grouped by mode (SAFE H1 VERSION)
const suggestionSets = {
  reflection: [
    "what I learned today",
    "a moment that taught me something",
    "something I understood better",
    "a choice I made and why",
    "what helped me stay calm"
  ],

  journal: [
    "today‚Äôs main moment",
    "something that stood out",
    "how my day went overall",
    "what I focused on today",
    "one thing I noticed today"
  ],

  note: [
    "a simple reminder",
    "something to improve slowly",
    "a thought to remember",
    "a small win today",
    "a clear point to keep in mind"
  ],

  affirmation: [
    "I can take things step by step",
    "I am learning and improving",
    "I can stay calm and focused",
    "I trust myself to try",
    "I am allowed to grow at my pace"
  ],

  poem: [
    "a quiet evening scene",
    "a calm moment in nature",
    "simple light and shadow",
    "a peaceful pause",
    "a gentle passing moment"
  ],

  story: [
    "a small turning point",
    "a simple journey forward",
    "a quiet change",
    "a helpful encounter",
    "a new beginning"
  ],

  letter: [
    "a note to myself",
    "a message for tomorrow",
    "a short appreciation note",
    "a kind message",
    "a simple update"
  ],

  quote: [
    "small steps matter",
    "clarity comes with patience",
    "progress is built daily",
    "calm thinking helps decisions",
    "consistency brings results"
  ]
};


// Mode selector + button handler
document.getElementById("suggestBtn").addEventListener("click", () => {
  const modes = document.getElementById("mode").value; // e.g. "poem", "journal"
  const list = suggestionSets[modes];
  const random = list[Math.floor(Math.random() * list.length)];
  document.getElementById("prompt").value = random;
});
function goHome() {
  window.location.href = "/";
}
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register("{% static 'pwa/service-worker.js' %}");
}
  </script>  
</body>  
</html> 
